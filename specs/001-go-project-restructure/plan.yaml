plan:
  branch: "001-go-project-restructure"
  created: "2025-12-14"
  spec_path: "specs/001-go-project-restructure/spec.yaml"

summary: |
  This implementation restructures the cclean codebase from a flat single-package layout
  to a standard Go project structure with cmd/cclean/, internal/parser/, and internal/display/
  directories. The restructure moves ~6000 lines of code while preserving all existing
  functionality, tests, and the build system.

  The key technical decisions are: (1) keeping types in internal/parser since they define
  the JSON schema for parsing, (2) placing all display formatters and their helpers in
  internal/display, and (3) maintaining a minimal cmd/cclean/main.go that handles only
  CLI flags and orchestrates the pipeline. This follows golang-standards/project-layout
  conventions while respecting the existing pipeline architecture.

technical_context:
  language: "Go"
  framework: "None"
  primary_dependencies:
    - name: "github.com/fatih/color"
      version: "v1.18.0"
      purpose: "Terminal color output"
    - name: "golang.org/x/term"
      version: "v0.38.0"
      purpose: "Terminal detection for color support"
  storage: "None"
  testing:
    framework: "Go testing package"
    approach: "Unit tests co-located with source files, style-specific test organization"
  target_platform: "Linux (amd64, arm64), macOS (Intel, Apple Silicon), Windows"
  project_type: "cli"
  performance_goals: "10MB max buffer for large outputs, line-by-line streaming"
  constraints:
    - "Binary name must remain 'cclean'"
    - "All existing Makefile targets must continue to work"
    - "No breaking changes to CLI interface"
    - "Import paths must use github.com/ariel-frischer/claude-clean module path"
  scale_scope: "Single-user CLI tool, processes JSONL streams"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Format Before Commit (PRIN-001)"
      status: "PASS"
      notes: "Will run make fmt before committing; no changes to formatting workflow"
    - name: "Static Analysis Clean (PRIN-002)"
      status: "PASS"
      notes: "Will run make vet to ensure clean analysis; package restructure may surface new warnings to fix"
    - name: "Test Coverage for Core Functions (PRIN-003)"
      status: "PASS"
      notes: "Tests move to their respective packages but test logic unchanged"
    - name: "Single Package Structure (PRIN-004)"
      status: "N/A"
      notes: "This restructure explicitly moves away from single-package; spec overrides this principle per exception clause 'Future growth may warrant package extraction'"
    - name: "Pipeline Architecture (PRIN-005)"
      status: "PASS"
      notes: "Pipeline stages preserved; just distributed across packages"
    - name: "Four Output Style Variants (PRIN-006)"
      status: "PASS"
      notes: "All 48 display functions remain, just moved to internal/display"
    - name: "Large Output Handling (PRIN-007)"
      status: "PASS"
      notes: "Buffer limits and truncation logic move to appropriate packages"
    - name: "Minimal Dependencies (PRIN-008)"
      status: "PASS"
      notes: "No new dependencies added"
    - name: "Cross-Platform Compatibility (PRIN-009)"
      status: "PASS"
      notes: "No platform-specific changes"
    - name: "Semantic Versioning (PRIN-010)"
      status: "PASS"
      notes: "This is a refactor, would be PATCH version bump"

research_findings:
  decisions:
    - topic: "Package boundary between parser and display"
      decision: "Display package imports parser types; parser has no display dependencies"
      rationale: "Unidirectional dependency prevents circular imports; display formatters need StreamMessage but parser doesn't need display"
      alternatives_considered:
        - "Shared types package (unnecessary complexity for this codebase)"
        - "Interface-based decoupling (over-engineering for a CLI tool)"

    - topic: "Location of configuration constants (10MB buffer, line truncation limits)"
      decision: "Keep in internal/parser package alongside parsing logic"
      rationale: "Buffer size relates to JSONL parsing; truncation happens during parsing phase"
      alternatives_considered:
        - "Separate internal/config package (too much indirection)"
        - "Keep in cmd/cclean/main.go (mixes concerns)"

    - topic: "Location of helper functions (stripSystemReminders, formatLineNum)"
      decision: "stripSystemReminders in parser (content processing), formatLineNum in display (output formatting)"
      rationale: "Functions grouped by their primary responsibility"
      alternatives_considered:
        - "All helpers in a shared internal/util package (unnecessary)"

    - topic: "Test file organization"
      decision: "Co-locate tests with source: internal/parser/*_test.go, internal/display/*_test.go"
      rationale: "Go convention; tests in same package can access unexported functions"
      alternatives_considered:
        - "Keep all tests in root (breaks with package restructure)"
        - "Separate test/ directory (not idiomatic Go)"

    - topic: "Global variables (verbose flag, style flag)"
      decision: "Define in cmd/cclean/main.go, pass as parameters to package functions"
      rationale: "Avoids package-level state; explicit dependencies are clearer"
      alternatives_considered:
        - "Global config struct (adds complexity)"
        - "Keep as package globals in internal packages (hidden dependencies)"

data_model:
  entities:
    - name: "StreamMessage"
      description: "Top-level JSON message from Claude stream (system/assistant/user/result)"
      fields:
        - name: "Type"
          type: "string"
          description: "Message type identifier"
          constraints: "One of: system, assistant, user, result"
        - name: "Message"
          type: "*MessageContent"
          description: "Optional message content container"
          constraints: "Present for assistant/user messages"
        - name: "Result"
          type: "string"
          description: "Final result text for result messages"
          constraints: "Present when Type=result"
      relationships:
        - target: "MessageContent"
          type: "one-to-one"
          description: "Contains message details when present"

    - name: "MessageContent"
      description: "Container for message content blocks"
      fields:
        - name: "Role"
          type: "string"
          description: "Message role (assistant/user)"
          constraints: "Required"
        - name: "Content"
          type: "[]ContentBlock"
          description: "Array of content blocks"
          constraints: "At least one block"
      relationships:
        - target: "ContentBlock"
          type: "one-to-many"
          description: "Contains multiple content pieces"

    - name: "ContentBlock"
      description: "Individual content piece (text, tool_use, tool_result)"
      fields:
        - name: "Type"
          type: "string"
          description: "Block type identifier"
          constraints: "One of: text, tool_use, tool_result"
        - name: "Text"
          type: "string"
          description: "Text content for text blocks"
          constraints: "Present when Type=text"
        - name: "Name"
          type: "string"
          description: "Tool name for tool_use blocks"
          constraints: "Present when Type=tool_use"
        - name: "Input"
          type: "map[string]interface{}"
          description: "Tool input parameters"
          constraints: "Present when Type=tool_use"
      relationships: []

    - name: "Usage"
      description: "Token usage statistics"
      fields:
        - name: "InputTokens"
          type: "int"
          description: "Number of input tokens"
          constraints: "Non-negative"
        - name: "OutputTokens"
          type: "int"
          description: "Number of output tokens"
          constraints: "Non-negative"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Update to reflect new package structure"
    - path: "README.md"
      description: "No changes needed (describes CLI usage, not internals)"

  source_code:
    - path: "cmd/cclean/main.go"
      description: "Entry point: flag parsing, input routing, pipeline orchestration"
    - path: "internal/parser/types.go"
      description: "JSON type definitions (StreamMessage, ContentBlock, etc.)"
    - path: "internal/parser/parser.go"
      description: "JSONL parsing, system reminder stripping, buffer management"
    - path: "internal/display/display.go"
      description: "Common display utilities, style routing, line formatting"
    - path: "internal/display/default.go"
      description: "Default style display functions"
    - path: "internal/display/compact.go"
      description: "Compact style display functions"
    - path: "internal/display/minimal.go"
      description: "Minimal style display functions"
    - path: "internal/display/plain.go"
      description: "Plain style display functions"

  tests:
    - path: "internal/parser/*_test.go"
      description: "Parser unit tests (stripSystemReminders, etc.)"
    - path: "internal/display/*_test.go"
      description: "Display function tests by style"
    - path: "mocks/"
      description: "Test fixtures remain in project root"

implementation_phases:
  - phase: 1
    name: "Create Package Structure"
    goal: "Set up directory structure and move type definitions"
    deliverables:
      - "Create cmd/cclean/ directory"
      - "Create internal/parser/ directory"
      - "Create internal/display/ directory"
      - "Move types.go to internal/parser/types.go with package declaration update"

  - phase: 2
    name: "Extract Parser Package"
    goal: "Move parsing logic to internal/parser"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Create internal/parser/parser.go with parsing functions"
      - "Move stripSystemReminders function"
      - "Move buffer constants and configuration"
      - "Export necessary types and functions"
      - "Create internal/parser/parser_test.go with moved tests"

  - phase: 3
    name: "Extract Display Package"
    goal: "Move all display formatters to internal/display"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Create internal/display/display.go with common utilities"
      - "Create internal/display/default.go with default style functions"
      - "Create internal/display/compact.go with compact style functions"
      - "Create internal/display/minimal.go with minimal style functions"
      - "Create internal/display/plain.go with plain style functions"
      - "Move formatLineNum, formatLineNumCompact helpers"
      - "Move display*_test.go files to internal/display/"

  - phase: 4
    name: "Create Entry Point"
    goal: "Implement minimal cmd/cclean/main.go"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Create cmd/cclean/main.go with flag parsing"
      - "Wire up imports to internal packages"
      - "Implement pipeline orchestration calling parser and display"
      - "Remove old root-level main.go"

  - phase: 5
    name: "Update Build System"
    goal: "Update Makefile and verify build works"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Update Makefile build target to compile cmd/cclean/main.go"
      - "Verify make build produces bin/cclean"
      - "Verify make test runs all tests"
      - "Verify make all pipeline works"

  - phase: 6
    name: "Cleanup and Verification"
    goal: "Remove old files, update documentation, final verification"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Remove old root-level Go files (main.go, types.go, *_test.go)"
      - "Update CLAUDE.md architecture section"
      - "Run full test suite"
      - "Run make all to verify formatting and static analysis"
      - "Manual verification with sample JSONL input"

risks:
  - risk: "Circular import between parser and display packages"
    likelihood: "low"
    impact: "high"
    mitigation: "Strict unidirectional dependency: display imports parser, never reverse. Design interface if needed."

  - risk: "Test failures due to unexported functions becoming inaccessible"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Tests move to same package as source; export test helpers if needed via _test.go files."

  - risk: "Global variable initialization order issues"
    likelihood: "low"
    impact: "medium"
    mitigation: "Pass configuration as function parameters rather than package-level globals."

  - risk: "Build path changes break CI workflow"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Test GitHub Actions workflow locally with act before merging."

  - risk: "Missing function during move causes runtime errors"
    likelihood: "medium"
    impact: "low"
    mitigation: "Compile after each phase; use go vet to catch undefined references."

open_questions:
  - question: "Should verbose flag be a global or passed through context?"
    context: "Many display functions check verbose flag; passing through all calls is verbose"
    proposed_resolution: "Use package-level variable in internal/display initialized from main; simpler than threading through all calls"

  - question: "Should tests/types.go be removed or kept?"
    context: "There's a tests/types.go file that may be test fixtures"
    proposed_resolution: "Examine content; if test fixtures, keep in tests/ or move to mocks/; if duplicate types, remove"

  - question: "Should main_test.go tests split between parser and display?"
    context: "main_test.go may test functions that will be in different packages"
    proposed_resolution: "Analyze test functions and move to appropriate package test files"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "dev"
  created: "2025-12-14T00:00:00Z"
  artifact_type: "plan"
